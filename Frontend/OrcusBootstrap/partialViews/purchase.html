<link href="assets/plugins/dropzone/dropzone.css" rel="stylesheet" >
<link href="assets/plugins/bootstrap-select/css/bootstrap-select.css" rel="stylesheet" />
<div class="container-fluid">
    <div class="row clearfix">
        <div class="col-lg-12 col-md-12 col-sm-12">
            <form id="PurchaseForm" class="card">
                <div class="header">
                    <h2><strong>Purchase</strong></h2>                        
                </div>
                <div class="body">
                    <h2 class="card-inside-title">Classification</h2>
                    <div class="row clearfix">
                        <div class="col-sm-4">
                            <span>Outlet</span>
                            <select id="Outlets" class="form-control show-tick">
                                <option value="">-- Please select --</option>
                            </select>
                        </div>
                        <div class="col-sm-4">
                            <span>Category</span>
                            <select id="Category" class="form-control show-tick">
                                <option value="">-- Please select --</option>
                            </select>
                        </div>
                        <div class="col-sm-4">
                            <span>Sub Category</span>
                            <select id="SubCategory" class="form-control show-tick">
                                <option value="">-- Please select --</option>
                            </select>
                        </div>
                    </div>
                    <h2 class="card-inside-title">Product Details</h2>
                    <div class="row clearfix">
                        <div class="form-group col-sm-4">
                            <span>Product Name</span>
                            <input id="ProductName" type="text" class="form-control" placeholder="Product name" />
                        </div>
                        <div class="col-sm-4">
                            <span>Unit</span>
                            <select id="Unit" class="form-control show-tick">
                                <option value="">-- Please select --</option>
                            </select>
                        </div>
                        <div class="form-group col-sm-4">
                            <span>Quantity</span>
                            <input id="Quantity" type="number" class="form-control" placeholder="Quantity" />
                        </div>
                    </div>
                    <h2 class="card-inside-title">Product Pricing</h2>
                    <div class="row clearfix">
                        <div class="form-group col-sm-4">
                            <span>Purchasing Price</span>
                            <input id="PurchasingPrice" type="number" class="form-control" placeholder="Purchasing Price" />
                        </div>
                        <div class="form-group col-sm-4">
                            <span>Retail Price</span>
                            <input id="RetailPrice" type="number" class="form-control" placeholder="Retail Price" />
                        </div>
                        <div class="form-group col-sm-2">
                            <span>Profit Amount</span>
                            <input id="ProfitAmount" type="text" class="form-control" placeholder="Profit Amount" disabled />
                        </div>
                        <div class="form-group col-sm-2">
                            <span>Profit Rate</span>
                            <input id="ProfitRate" type="text" class="form-control" placeholder="Profit Rate" disabled />
                        </div>
                    </div>
                    <h2 class="card-inside-title">Costing</h2>
                    <div class="row clearfix">
                        <div class="form-group col-sm-4">
                            <span>Total Amount</span>
                            <input id="TotalAmount" type="number" class="form-control" placeholder="Total Amount" disabled />
                        </div>
                        <div class="form-group col-sm-4">
                            <span>Due Amount</span>
                            <input id="DueAmount" type="number" class="form-control" placeholder="Due Amount" />
                        </div>
                        <div class="form-group col-sm-4">
                            <span>Net Amount</span>
                            <input id="NetAmount" type="number" class="form-control" placeholder="Net Amount" disabled/>
                        </div>
                    </div>
                    <h2 class="card-inside-title">Product Description</h2>
                    <div class="row clearfix">
                        <div class="col-sm-12">
                            <div class="form-group">
                                <div class="form-line">
                                    <textarea id="ProductDescription" rows="4" class="form-control no-resize" placeholder="Please type your product description..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- File Upload | Drag & Drop OR With Click & Choose -->
                    <div class="row clearfix">
                        <div class="col-lg-12 col-md-12 col-sm-12">
                            <div class="card">
                                <div class="header">
                                    <h2><strong>Upload Product Images</strong> Drag & Drop OR With Click & Choose </h2>
                                </div>
                                <div class="body">
                                    <div id="frmFileUpload" class="dropzone" enctype="multipart/form-data">
                                        <div class="dz-message">
                                            <div class="drag-icon-cph"> <i class="material-icons">touch_app</i> </div>
                                            <h3>Drop files here or click to upload.</h3>
                                        </div>
                                        <div class="fallback">
                                            <input name="file" type="file" multiple />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-12 col-lg-6">
                            <button type="submit" class="col-sm-12 col-lg-6 btn btn-raised btn-primary btn-round waves-effect m-lg-l-20 custom-btn">Purchase</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <script>
        dropzone = new Dropzone('#frmFileUpload', {
                url: "/file/post",
                parallelUploads: 5,
                uploadMultiple: true,
                acceptedFiles: '.png, .jpg, .jpeg',
                autoProcessQueue: false
            });
        onLoad = () => {
            $('#PurchasingPrice').change(() => {
                calculatePrice();
            });
            
            $('#RetailPrice').change(() => {
                calculateProfit();
                calculateNetAmount();
            });

            $('#Quantity').change(() => {
                calculatePrice();
                calculateNetAmount();
            });
            
            $('#DueAmount').change(() => {
                calculateNetAmount();
            });

            loadUnits();

            Service.RefreshOutletListOnDropdown(['Outlets']);
            Service.RefreshOutletListOnLeftSideBar('purchase');
        }

        $(document).ready(() => {
            var subCategories = [];

            $('#Outlets').change(() => {
                let param = {
                    URL: Route.Base + Route.Categories.Get + $("#Outlets").val(),
                    Method: 'GET',
                    Success: (res) => {
                        if (res.response.length > 1){
                            $.each(res.response, (key, category) => {
                                if(category.parentCategoryId == null){
                                    $('#Category').append(
                                        '<option value="'+ category.categoryId +'">' + category.categoryName + '</option>'
                                    );
                                }
                                else{
                                    subCategories.push(category);
                                }
                            });
                        }
                        $('select').selectpicker('refresh');
                    },
                };
                
                APIConsumptionAuth(param);
            });

            $('#Category').change(() => {
                $.each(subCategories, (key, subCategory) => {
                    if(subCategory.parentCategoryId != null){
                        $('#SubCategory').append(
                            '<option value="'+ subCategory.categoryId +'">' + subCategory.categoryName + '</option>'
                        );
                    }
                });

                $('select').selectpicker('refresh');
            });
        });

        calculateProfit = () => {
            let retailPrice = $('#RetailPrice').val();
            let purchasePrice = $('#PurchasingPrice').val();
            
            let profitAmount = retailPrice - purchasePrice;
            let profitRate = profitAmount / purchasePrice;
            
            profitRate = profitRate * 100;
            
            $('#ProfitAmount').val(profitAmount);
            $('#ProfitRate').val(profitRate.toFixed(2).toString() + '%');
        }

        calculatePrice = () => {
            $('#TotalAmount').val($('#Quantity').val() * $('#PurchasingPrice').val());
        }

        calculateNetAmount = () => {
            let dueAmount = $('#DueAmount').val();
            if (dueAmount == NaN || dueAmount == null || dueAmount == undefined || dueAmount == ""){
                dueAmount = 0;
                $('#DueAmount').val('0');
            }
            $('#NetAmount').val($('#TotalAmount').val() - $('#DueAmount').val());
        }

        loadUnits = () => {
            let param = {
                URL: Route.Base + Route.Product.Get,
                Method: 'GET',
                Success: (res) => {
                    $('#Unit').empty();
                    $('#Unit').append('<option value="">-- Please select --</option>');
                    $.each(res.response, (key, unit) => {
                        $('#Unit').append(
                            '<option value="'+ unit.unitTypeId +'">' + unit.unitTypeName + '</option>'
                        );  
                    });
                    
                    $('select').selectpicker('refresh');
                },
            };
            
            APIConsumptionAuth(param);
        };

        $('#PurchaseForm').on('submit', (element) => {
            element.preventDefault();
            console.log(JSON.stringify({
                OutletId: $('#Outlets').val(),
                CategoryId: $('#Category').val(),
                SubCategoryId: $('#SubCategory').val(),
                ProductName: $('#ProductName').val(),
                UnitId: $('#Unit').val(),
                Quantity: $('#Quantity').val(),
                PurchasingPrice: $('#PurchasingPrice').val(),
                RetailPrice: $('#RetailPrice').val(),
                DueAmount: $('#DueAmount').val(),
                ProductDescription: $('#ProductDescription').val(),
            }));
            // dropzone.processQueue();
        })
    </script>
</div>
<style>
    #PurchaseForm .form-group span{
        margin-bottom: 10px;
        display: block;
    }
</style>