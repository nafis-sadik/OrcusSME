<div id="CategoryManager" class="container-fluid">
    <div class="row clearfix">
        <div class="col-lg-12 col-md-12 col-sm-12">
            <div class="card">
                <div class="header">
                    <h2><strong>Add or Remove Categories</strong></h2>
                    <ul class="header-dropdown">
                        <li class="dropdown"> <a href="javascript:void(0);" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> <i class="zmdi zmdi-more"></i> </a>
                            <ul class="dropdown-menu">
                                <li><a href="javascript:void(0);">Action</a></li>
                                <li><a href="javascript:void(0);">Another action</a></li>
                                <li><a href="javascript:void(0);">Something else</a></li>
                            </ul>
                        </li>
                        <li class="remove">
                            <a role="button" class="boxs-close"><i class="zmdi zmdi-close"></i></a>
                        </li>
                    </ul>
                </div>
                <div class="body">
                    <div class="row clearfix">                        
                        <div class="col-sm-12">
                            <h1 class="card-inside-title">Select Outlet</h1>
                            <select id="OutletSelection" class="form-control show-tick">
                                <option value="">-- Please select --</option>
                                <option value="1">Percentage</option>
                                <option value="2">Fixed Amount</option>
                            </select>
                        </div>
                    </div>
                    <br>
                    <br>
                    <div class="row clearfix">
                        <div class="form-group col-sm-12 col-lg-6">
                            <h1 class="card-inside-title">Add New Category</h1>
                            <input id="CategoryName" type="text" class="form-control btn" placeholder="Category Name">
                            <button onclick="SaveCategories()" type="button" class="col-sm-12 btn btn-raised btn-primary btn-round waves-effect m-lg-l-20 custom-btn">Add</button>
                        </div>
                        <div class="col-sm-12 col-lg-6">
                            <h1 class="card-inside-title">Remove Category</h1>
                            <select id="RemoveCategorySelect" class="form-control show-tick">
                                <option value="">-- Please select --</option>
                            </select>
                            <button onclick="RemoveCategories()" type="button" class="col-sm-12 btn btn-raised btn-primary btn-round waves-effect m-lg-l-20 custom-btn">Remove</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>  
<div class="container-fluid">
    <div class="row clearfix"> 
        <div class="col-lg-12 col-md-12">
            <div class="card">
                <div class="header">
                    <h2>
                        <strong>Manage Categories & Subcategories</strong><small>Drag & drop hierarchical list with mouse or touch</small>
                    </h2>
                    <ol class="header-dropdown">
                        <li class="dropdown"> <a href="javascript:void(0);" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> <i class="zmdi zmdi-more"></i> </a>
                            <ol class="dropdown-menu">
                                <li><a href="javascript:void(0);">Action</a></li>
                                <li><a href="javascript:void(0);">Another action</a></li>
                                <li><a href="javascript:void(0);">Something else</a></li>
                            </ol>
                        </li>
                        <li class="remove">
                            <a role="button" class="boxs-close"><i class="zmdi zmdi-close"></i></a>
                        </li>
                    </ol>
                </div>
                <div class="body">
                    <div class="clearfix m-b-20">
                        <div class="dd">
                            <ol id="CategoryHierarchy" class="dd-list">
                                <li class="dd-item" data-id="1">
                                    <div class="dd-handle dd3-handle"></div>
                                    <div class="dd3-content">Clothing</div>
                                </li>
                                <li class="dd-item" data-id="2">
                                    <div class="dd-handle dd3-handle"></div>
                                    <div class="dd3-content">Shoes</div>
                                    <ol class="dd-list">
                                        <li class="dd-item" data-id="3">
                                            <div class="dd-handle dd3-handle"></div>
                                            <div class="dd3-content">Converse</div>
                                        </li>
                                        <li class="dd-item" data-id="4">
                                            <div class="dd-handle dd3-handle"></div>
                                            <div class="dd3-content">Leather</div>
                                        </li>
                                        <li class="dd-item" data-id="5">
                                            <div class="dd-handle dd3-handle"></div>
                                            <div class="dd3-content">Fabric</div>
                                            <ol class="dd-list">
                                                <li class="dd-item" data-id="6">
                                                    <div class="dd-handle dd3-handle"></div>
                                                    <div class="dd3-content">Jeans</div>
                                                </li>
                                                <li class="dd-item" data-id="7">
                                                    <div class="dd-handle dd3-handle"></div>
                                                    <div class="dd3-content">Cotton</div>
                                                </li>   
                                            </ol>
                                        </li>
                                        <li class="dd-item" data-id="9">
                                            <div class="dd-handle dd3-handle"></div>
                                            <div class="dd3-content">Formal Shoes</div>
                                        </li>
                                        <li class="dd-item" data-id="10">
                                            <div class="dd-handle dd3-handle"></div>
                                            <div class="dd3-content">Casual Shoes</div>
                                        </li>
                                    </ol>
                                </li>
                                <li class="dd-item" data-id="11">
                                    <div class="dd-handle dd3-handle"></div>
                                    <div class="dd3-content">Gadgets</div>
                                </li>
                                <li class="dd-item" data-id="12">
                                    <div class="dd-handle dd3-handle"></div>
                                    <div class="dd3-content">Home Appliances</div>  
                                </li>
                            </ol>
                        </div>
                    </div>
                    <b>Output JSON</b>
                    <textarea id="CategoryHierarchyJson" cols="30" rows="3" class="form-control no-resize" readonly></textarea>
                    <div class="row clearfix p-l-0 m-l-0 p-t-10">
                        <div class="col-sm-8"> </div>
                        <button id="SaveCategoryHierarchy" role="menuitem" class="col-sm-4 btn btn-raised btn-primary waves-effect waves-light custom-btn p-l-0 m-l-0">Save</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- #END# Default Example --> 
    </div>        
</div>

<script src="assets/js/pages/orcus/sortable-nestable.js"></script>
<script>
    CategoryHirarchyRefresh = (res) => {
        // Refresh Category Hierarchy
        $('#CategoryHierarchy').empty();
        $.each(res.response, (index, category) => {
            if(category.parentCategoryId == 0 || category.parentCategoryId == null || category.parentCategoryId == NaN){
                $('#CategoryHierarchy').append(
                    '<li class="dd-item" data-id="'+ category.categoryId +'">'
                        + '<div class="dd-handle dd3-handle"></div>'
                        + '<div class="dd3-content">'+ category.categoryName +'</div>'
                    +'</li>'
                );
            }
            else{
                let targetElement = $('#CategoryHierarchy [data-id="' + category.parentCategoryId + '"]');
                if($(targetElement).find('.dd-list').length <= 0){
                    $(targetElement).append(
                    '<ol class="dd-list">'+
                        '<li class="dd-item" data-id="3">'+
                            '<div class="dd-handle dd3-handle"></div>'+
                            '<div class="dd3-content">' + category.categoryName + '</div>'+
                        '</li>'+
                    '</ol>')
                }
                else{
                    $(targetElement).find('.dd-list').append(
                        '<li class="dd-item" data-id="3">'+
                            '<div class="dd-handle dd3-handle"></div>'+
                            '<div class="dd3-content">' + category.categoryName + '</div>'+
                        '</li>'
                    );
                }
            }
        });

        // Refresh Category Hierarchy Output JSON
        $('#CategoryHierarchyJson').empty();
        NestableInit('CategoryHierarchyJson');
    }

    RemoveCategoryDropdownRefresh = (res) => {
        // Append to Remove Category Dropdown
        $('#RemoveCategorySelect').empty();
        $('#CategoryHierarchyJson').empty();
        $('#RemoveCategorySelect').append('<option value="">-- Please select --</option>');
        $.each(res.response, (index, category) => {
            $('#RemoveCategorySelect').append(
                '<option value="'+ category.categoryId +'">'+ category.categoryName +'</option>'
            );
        })
        $('#RemoveCategorySelect').selectpicker('refresh');
    }

    SaveCategories = () => {
        let outletId = $('#OutletSelection').val();
        if(outletId == "" || outletId == undefined || outletId == NaN){
            swal.fire('You must choose an outlet', '', 'info');
            return;
        }

        let categoryName = $("#CategoryName").val();
        if(categoryName == "" || categoryName == undefined || categoryName == NaN){
            swal.fire('You must have a category name', '', 'info');
            return;
        }

        let param = {
            URL: Route.Base + Route.Categories.Add,
            Method: 'PUT',
            Data: {
                "categoryId": 0,
                "categoryName": categoryName,
                "parentCategoryId": 0,
                "outletId": outletId,
                "userId": localStorage.getItem('userId')
            },
            Success: (res) => {
                if(res.response.length == 0) {
                    swal.fire(categoryName + ' already exists!', '', "info");
                    return;
                }
                swal.fire('Successfully Saved!', '', "success");
                RemoveCategoryDropdownRefresh(res); 
                CategoryHirarchyRefresh(res);
            },
        };

        APIConsumptionAuth(param);
    }

    RemoveCategories = () => {
        let outletId = $('#OutletSelection').val();
        if(outletId == "" || outletId == undefined || outletId == NaN){
            swal.fire('You must choose an outlet', '', 'info');
            return;
        }

        let categoryName = $("#RemoveCategorySelect").val();
        if(categoryName == "" || categoryName == undefined || categoryName == NaN){
            swal.fire('You must select a category name', '', 'info');
            return;
        }

        let param = {
            URL: Route.Base + Route.Categories.Delete + $("#RemoveCategorySelect").val(),
            Method: 'DELETE',
            Success: (res) => {
                swal.fire('Success!', '', "success");
                // return;
                RemoveCategoryDropdownRefresh(res); 
                CategoryHirarchyRefresh(res);
            },
        };

        APIConsumptionAuth(param);
    }

    $('#OutletSelection').change((elem) => {
        // Must select an outlet
        let outletId = $('#OutletSelection').val();
        if(outletId == "" || outletId == undefined || outletId == NaN){
            swal.fire('You must choose an outlet', '', 'error');
            return;
        }
        
        // Load Categories
        let param = {
            URL: Route.Base + Route.Categories.Get + outletId,
            Method: 'GET',
            Data: null,
            Success: (res) => {
                RemoveCategoryDropdownRefresh(res);
                CategoryHirarchyRefresh(res);
            },
        };

        APIConsumptionAuth(param);
    });

    $('#SaveCategoryHierarchy').click(() => {
        let outletId = $('#OutletSelection').val();
        let categoryHierarchyJson = $('#CategoryHierarchyJson').val();
        let param = {
            URL: Route.Base + Route.Categories.SaveHierarchy,
            Method: 'POST',
            Data: {
                CategoryHiararchy: categoryHierarchyJson,
                outletId: outletId
            },
            Success: (res) => {
                console.log(res);
            }
        };

        APIConsumptionAuth(param);
    });

    onLoad = () => {
        Service.RefreshOutletListOnDropdown('OutletSelection');
    }

    $(document).ready(() => {
        $('select').selectpicker();
        NestableInit('CategoryHierarchyJson');
    });
</script>
<style>
    #CategoryManager form{
        width: 100%;
    }

    #CategoryManager .custom-btn{
        min-width: 10vw;
    }
</style>